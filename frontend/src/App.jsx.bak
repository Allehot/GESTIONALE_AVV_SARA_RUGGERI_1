import React, { useEffect, useMemo, useState } from "react";
const API_BASE = "/api";

// Stili base
const pageStyle = {
  fontFamily: "system-ui, -apple-system, BlinkMacSystemFont, sans-serif",
  background: "#f4f4f5",
  minHeight: "100vh"
};
const topbarStyle = {
  background: "#111827",
  color: "#fff",
  padding: "10px 20px",
  display: "flex",
  alignItems: "center",
  justifyContent: "space-between"
};
const mainStyle = { display: "flex", minHeight: "calc(100vh - 52px)" };
const sidebarStyle = {
  width: 240,
  background: "#fff",
  borderRight: "1px solid #e5e7eb",
  padding: 16
};
const btn = {
  background: "#2563eb",
  color: "#fff",
  border: "none",
  padding: "6px 12px",
  borderRadius: 6,
  cursor: "pointer"
};
const searchInput = {
  padding: "6px 10px",
  borderRadius: 6,
  border: "1px solid #d1d5db",
  minWidth: 220
};
const card = {
  background: "#fff",
  borderRadius: 10,
  padding: 16,
  marginBottom: 16,
  boxShadow: "0 1px 2px rgba(0,0,0,0.04)"
};

const statusColor = (t) => {
  if (!t) return "#e5e7eb";
  const tl = t.toLowerCase();
  if (tl.includes("udienza")) return "#fee2e2"; // rosso chiaro
  if (tl.includes("termine")) return "#fef9c3"; // giallo chiaro
  return "#e0f2fe"; // azzurrino per scadenza
};

const guardianStatusColor = (status) => {
  if (!status) return "#e5e7eb";
  const value = status.toLowerCase();
  if (value === "attivo") return "#bbf7d0";
  if (value === "chiuso" || value === "archiviato") return "#fbcfe8";
  return "#e0e7ff";
};

function App() {
  // auth
  const [user, setUser] = useState(null);
  const [loginUser, setLoginUser] = useState("admin");
  const [loginPass, setLoginPass] = useState("admin");
  const [loginError, setLoginError] = useState("");

  const [isLoading, setIsLoading] = useState(false);
  const [loadError, setLoadError] = useState("");
  const [lastUpdated, setLastUpdated] = useState(null);

  // vista corrente
  const [view, setView] = useState("dashboard");

  // dati principali
  const [studio, setStudio] = useState(null);
  const [clients, setClients] = useState([]);
  const [cases, setCases] = useState([]);
  const [deadlines, setDeadlines] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [guardianships, setGuardianships] = useState([]);

  // dashboard
  const [dashboard, setDashboard] = useState(null);
  const [upcoming, setUpcoming] = useState([]);
  const [monthly, setMonthly] = useState(null);

  // filtri
  const [clientQuery, setClientQuery] = useState("");
  const [caseQuery, setCaseQuery] = useState("");
  const [caseStatusFilter, setCaseStatusFilter] = useState("all");
  const [invoiceQuery, setInvoiceQuery] = useState("");
  const [deadlineQuery, setDeadlineQuery] = useState("");
  const [deadlineTypeFilter, setDeadlineTypeFilter] = useState("all");

  // modali
  const [showNewClient, setShowNewClient] = useState(false);
  const [showNewCase, setShowNewCase] = useState(false);
  const [showNewInvoice, setShowNewInvoice] = useState(false);
  const [showNewDeadline, setShowNewDeadline] = useState(false);
  const [showGuardianModal, setShowGuardianModal] = useState(false);
  const [editingGuardian, setEditingGuardian] = useState(null);

  // dettaglio pratica
  const [selectedCase, setSelectedCase] = useState(null);
  const [caseLogs, setCaseLogs] = useState([]);
  const [newCaseNote, setNewCaseNote] = useState("");
  const [selectedGuardian, setSelectedGuardian] = useState(null);
  const [guardianDetailTab, setGuardianDetailTab] = useState("overview");
  const [guardianDetailLoading, setGuardianDetailLoading] = useState(false);
  const [guardianEntryModal, setGuardianEntryModal] = useState(null);
  const guardianTabs = [
    { id: "overview", label: "Scheda" },
    { id: "documents", label: "Documenti" },
    { id: "inventory", label: "Inventario" },
    { id: "finance", label: "Entrate / Uscite" },
    { id: "reports", label: "Rendiconti" },
    { id: "filings", label: "Depositi telematici" }
  ];

  // modale modifica scadenza (da calendario o lista)
  const [editDeadline, setEditDeadline] = useState(null);

  // import
  const [importType, setImportType] = useState("clients");
  const [importFile, setImportFile] = useState(null);

  // calendario: anno/mese navigabili
  const [calendarYear, setCalendarYear] = useState(new Date().getFullYear());
  const [calendarMonth, setCalendarMonth] = useState(new Date().getMonth()); // 0-11
  const [calendarCopyStatus, setCalendarCopyStatus] = useState("");
  const calendarCopyTimeout = useRef(null);

  const casesById = useMemo(() => {
    const map = new Map();
    cases.forEach((c) => {
      map.set(c.id, c);
    });
    return map;
  }, [cases]);

  const filteredClients = useMemo(() => {
    const query = normalizeText(clientQuery);
    if (!query) return clients;
    return clients.filter((cl) =>
      [cl.name, cl.email, cl.phone, cl.fiscalCode, cl.vatNumber]
        .map(normalizeText)
        .some((value) => value.includes(query))
    );
  }, [clients, clientQuery]);

  const filteredCases = useMemo(() => {
    const query = normalizeText(caseQuery);
    return cases.filter((c) => {
      if (caseStatusFilter !== "all" && normalizeText(c.status) !== normalizeText(caseStatusFilter)) {
        return false;
      }
      if (!query) return true;
      return [c.number, c.subject, c.clientName, c.caseType, c.proceedingType, c.status]
        .map(normalizeText)
        .some((value) => value.includes(query));
    });
  }, [cases, caseQuery, caseStatusFilter]);

  const filteredInvoices = useMemo(() => {
    const query = normalizeText(invoiceQuery);
    if (!query) return invoices;
    return invoices.filter((inv) =>
      [inv.number, inv.clientName, inv.caseNumber, inv.date]
        .map(normalizeText)
        .some((value) => value.includes(query))
    );
  }, [invoices, invoiceQuery]);

  const filteredDeadlines = useMemo(() => {
    const query = normalizeText(deadlineQuery);
    return deadlines.filter((d) => {
      if (deadlineTypeFilter !== "all" && normalizeText(d.type) !== normalizeText(deadlineTypeFilter)) {
        return false;
      }
      if (!query) return true;
      const relatedCase = casesById.get(d.caseId);
      return [d.date, d.type, d.description, relatedCase ? relatedCase.subject : "", relatedCase ? relatedCase.number : ""]
        .map(normalizeText)
        .some((value) => value.includes(query));
    });
  }, [deadlines, deadlineQuery, deadlineTypeFilter, casesById]);

  const calendarFeedUrl = useMemo(() => {
    if (typeof window === "undefined") {
      return `${API_BASE}/deadlines/ics`;
    }
    const origin = window.location && window.location.origin ? window.location.origin : "";
    if (!origin || origin === "null") {
      return `${API_BASE}/deadlines/ics`;
    }
    return `${origin}${API_BASE}/deadlines/ics`;
  }, []);

  const calendarSubscribeUrl = useMemo(() => {
    if (!calendarFeedUrl) return "";
    try {
      const url = new URL(calendarFeedUrl, typeof window !== "undefined" ? window.location.href : undefined);
      url.protocol = "webcal:";
      return url.toString();
    } catch (err) {
      if (calendarFeedUrl.startsWith("https://")) {
        return `webcal://${calendarFeedUrl.slice("https://".length)}`;
      }
      if (calendarFeedUrl.startsWith("http://")) {
        return `webcal://${calendarFeedUrl.slice("http://".length)}`;
      }
      return calendarFeedUrl;
    }
  }, [calendarFeedUrl]);

  useEffect(() => {
    return () => {
      if (calendarCopyTimeout.current) {
        clearTimeout(calendarCopyTimeout.current);
      }
    };
  }, []);

  const copyCalendarLink = async () => {
    if (!calendarFeedUrl) return;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(calendarFeedUrl);
        setCalendarCopyStatus("Link copiato negli appunti.");
      } else {
        window.prompt("Copia il link del calendario", calendarFeedUrl);
        setCalendarCopyStatus("Copia il link mostrato e incollalo in Calendario Apple.");
      }
    } catch (err) {
      setCalendarCopyStatus("Copia non riuscita, copia manualmente il link sottostante.");
    }
    if (calendarCopyTimeout.current) {
      clearTimeout(calendarCopyTimeout.current);
    }
    calendarCopyTimeout.current = setTimeout(() => {
      setCalendarCopyStatus("");
    }, 4000);
  };
  // caricamento di tutti i dati
  async function loadAll() {
    setIsLoading(true);
    setLoadError("");
    try {
      const [
        studioData,
        clientsData,
        casesData,
        deadlinesData,
        invoicesData,
        dashboardData,
        upcomingData,
        monthlyData
      ] = await Promise.all([
        fetchJson(`${API_BASE}/studio`),
        fetchJson(`${API_BASE}/clienti`),
        fetchJson(`${API_BASE}/casi`),
        fetchJson(`${API_BASE}/scadenze`),
        fetchJson(`${API_BASE}/fatture`),
        fetchJson(`${API_BASE}/reports/dashboard`),
        fetchJson(`${API_BASE}/reports/recenti`),
        fetchJson(`${API_BASE}/reports/mesi`)
      ]);

      setStudio(studioData);
      setClients(Array.isArray(clientsData) ? clientsData : []);
      setCases(Array.isArray(casesData) ? casesData : []);
      setDeadlines(Array.isArray(deadlinesData) ? deadlinesData : []);
      setInvoices(Array.isArray(invoicesData) ? invoicesData : []);
      setDashboard(dashboardData || null);
      setUpcoming(Array.isArray(upcomingData) ? upcomingData : []);
      setMonthly(monthlyData || null);
      setLastUpdated(new Date());
    } catch (err) {
      console.error("Errore durante il caricamento dei dati", err);
      setLoadError(err.message || "Impossibile caricare i dati");
    } finally {
      setIsLoading(false);
    }
  }

  const runOrAlert = async (action, errorMessage) => {
    try {
      await action();
      return true;
    } catch (err) {
      console.error(errorMessage, err);
      alert(`${errorMessage}${err?.message ? `: ${err.message}` : ""}`);
      return false;
    }
  };

  useEffect(() => {
    if (user) {
      loadAll();
    }
  }, [user]);

  // login
  const doLogin = async (e) => {
    e.preventDefault();
    try {
      const data = await fetchJson(`${API_BASE}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: loginUser, password: loginPass })
      });
      if (!data || !data.user) {
        throw new Error("Credenziali non valide");
      }
      setUser(data.user);
      setLoginError("");
    } catch (err) {
      setLoginError(err.message || "Credenziali non valide");
    }
  };

  // CLIENTI ---------------------------------------------------
  const submitNewClient = async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = {
      name: form.name.value,
      fiscalCode: form.fiscalCode.value,
      vatNumber: form.vatNumber.value,
      email: form.email.value,
      pec: form.pec.value,
      phone: form.phone.value,
      address: form.address.value,
      notes: form.notes.value
    };
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/clients`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      "Errore durante la creazione del cliente"
    );
    if (!success) return;
    setShowNewClient(false);
    await loadAll();
  };

  const editClient = async (cl) => {
    const name = window.prompt("Nome cliente", cl.name);
    if (!name) return;
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/clients/${cl.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name })
        }),
      "Errore durante l'aggiornamento del cliente"
    );
    if (success) {
      await loadAll();
    }
  };

  const deleteClient = async (cl) => {
    if (!window.confirm("Eliminare questo cliente?")) return;
    const success = await runOrAlert(
      () => fetchJson(`${API_BASE}/clients/${cl.id}`, { method: "DELETE" }),
      "Impossibile eliminare il cliente (ha pratiche o fatture collegate?)"
    );
    if (success) {
      await loadAll();
    }
  };

  // PRATICHE ---------------------------------------------------
  const submitNewCase = async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = {
      subject: form.subject.value,
      clientId: form.clientId.value || null,
      caseType: form.caseType.value,
      proceedingType: form.proceedingType.value,
      court: form.court.value,
      rgNumber: form.rgNumber.value,
      status: "aperta"
    };
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/cases`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      "Errore durante la creazione della pratica"
    );
    if (!success) return;
    setShowNewCase(false);
    await loadAll();
  };

  const openCase = async (c) => {
    try {
      const [caseData, logsData] = await Promise.all([
        fetchJson(`${API_BASE}/cases/${c.id}`),
        fetchJson(`${API_BASE}/cases/${c.id}/logs`)
      ]);
      setSelectedCase(caseData);
      setCaseLogs(Array.isArray(logsData) ? logsData : []);
      setView("case-detail");
    } catch (err) {
      console.error("Impossibile aprire la pratica", err);
      alert(`Impossibile aprire la pratica: ${err?.message || "Errore sconosciuto"}`);
    }
  };

  const editCase = async (c) => {
    const subject = window.prompt("Oggetto pratica:", c.subject);
    if (!subject) return;
    const proceedingType = window.prompt("Procedimento (giudiziale/stragiudiziale):", c.proceedingType || "stragiudiziale");
    const status = window.prompt("Stato (aperta/chiusa):", c.status || "aperta");
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/cases/${c.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ subject, status, proceedingType })
        }),
      "Errore durante l'aggiornamento della pratica"
    );
    if (success) {
      await loadAll();
    }
  };

  const deleteCase = async (c) => {
    if (!window.confirm("Eliminare la pratica e le scadenze collegate?")) return;
    const success = await runOrAlert(
      () => fetchJson(`${API_BASE}/cases/${c.id}`, { method: "DELETE" }),
      "Errore durante l'eliminazione della pratica"
    );
    if (success) {
      await loadAll();
      setSelectedCase(null);
      setView("cases");
    }
  };

  // CRONOSTORIA - nota manuale
  const addManualNote = async () => {
    if (!selectedCase || !newCaseNote.trim()) return;
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/cases/${selectedCase.id}/logs`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ detail: newCaseNote })
        }),
      "Errore durante l'inserimento della nota"
    );
    if (!success) return;
    try {
      const logsData = await fetchJson(`${API_BASE}/cases/${selectedCase.id}/logs`);
      setCaseLogs(Array.isArray(logsData) ? logsData : []);
      setNewCaseNote("");
    } catch (err) {
      console.error("Errore durante il ricaricamento delle note", err);
    }
  };

  // SCADENZE / UDIENZE ------------------------------------------
  const submitNewDeadline = async (e) => {
    e.preventDefault();
    const form = e.target;
    const caseId = form.caseId.value;
    if (!caseId) {
      alert("Seleziona una pratica");
      return;
    }
    const payload = {
      date: form.date.value,
      description: form.description.value,
      type: form.type.value
    };
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/cases/${caseId}/deadlines`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      "Errore durante la creazione della scadenza"
    );
    if (!success) return;
    setShowNewDeadline(false);
    await loadAll();
    // se sono nel dettaglio pratica, la ricarico
    if (selectedCase && selectedCase.id === caseId) {
      try {
        const caseData = await fetchJson(`${API_BASE}/cases/${caseId}`);
        setSelectedCase(caseData);
      } catch (err) {
        console.error("Errore durante il ricaricamento della pratica", err);
      }
    }
  };

  const deleteDeadline = async (d) => {
    if (!window.confirm("Eliminare questa scadenza/udienza?")) return;
    const success = await runOrAlert(
      () => fetchJson(`${API_BASE}/deadlines/${d.id}`, { method: "DELETE" }),
      "Errore durante l'eliminazione della scadenza"
    );
    if (!success) return;
    await loadAll();
    // se √® della pratica che sto vedendo, aggiorno
    if (selectedCase && d.caseId === selectedCase.id) {
      try {
        const [caseData, logsData] = await Promise.all([
          fetchJson(`${API_BASE}/cases/${selectedCase.id}`),
          fetchJson(`${API_BASE}/cases/${selectedCase.id}/logs`)
        ]);
        setSelectedCase(caseData);
        setCaseLogs(Array.isArray(logsData) ? logsData : []);
      } catch (err) {
        console.error("Errore durante l'aggiornamento della pratica", err);
      }
    }
    setEditDeadline(null);
  };

  const updateDeadline = async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = {
      date: form.date.value,
      description: form.description.value,
      type: form.type.value
    };
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/deadlines/${editDeadline.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      "Errore durante l'aggiornamento della scadenza"
    );
    if (!success) return;
    setEditDeadline(null);
    await loadAll();
  };

  // AMMINISTRATI DI SOSTEGNO -----------------------------------
  const openGuardian = async (g) => {
    if (!g || !g.id) return;
    if (view !== "guardianships") {
      setView("guardianships");
    }
    setGuardianDetailLoading(true);
    try {
      const detail = await runOrAlert(
        () => fetchJson(`${API_BASE}/guardianships/${g.id}`),
        "Errore durante il caricamento della scheda AdS"
      );
      if (detail) {
        applyGuardianUpdate(detail, { select: true });
      }
    } finally {
      setGuardianDetailLoading(false);
    }
  };

  const startNewGuardian = () => {
    setEditingGuardian(null);
    setShowGuardianModal(true);
  };

  const startEditGuardian = (g) => {
    setEditingGuardian(g);
    setShowGuardianModal(true);
  };

  const closeGuardianModal = () => {
    setShowGuardianModal(false);
    setEditingGuardian(null);
  };

  const openGuardianEntryModal = (type, item = null) => {
    setGuardianEntryModal({ type, item });
  };

  const closeGuardianEntryModal = () => {
    setGuardianEntryModal(null);
  };

  const submitGuardian = async (e) => {
    e.preventDefault();
    const editing = editingGuardian;
    const form = e.target;
    const payload = {
      fullName: form.fullName.value.trim(),
      birthDate: form.birthDate.value,
      fiscalCode: form.fiscalCode.value.trim(),
      residence: form.residence.value.trim(),
      supportLevel: form.supportLevel.value.trim(),
      court: form.court.value.trim(),
      judge: form.judge.value.trim(),
      decreeDate: form.decreeDate.value,
      reportingFrequency: form.reportingFrequency.value.trim(),
      nextReportDue: form.nextReportDue.value,
      lastReportSent: form.lastReportSent.value,
      income: form.income.value.trim(),
      healthNotes: form.healthNotes.value.trim(),
      socialServicesContact: form.socialServicesContact.value.trim(),
      familyContacts: form.familyContacts.value.trim(),
      notes: form.notes.value.trim(),
      status: form.status.value
    };
    const url = editing ? `${API_BASE}/guardianships/${editing.id}` : `${API_BASE}/guardianships`;
    const method = editing ? "PUT" : "POST";
    const result = await runOrAlert(
      () =>
        fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      editing ? "Errore durante l'aggiornamento dell'amministrato" : "Errore durante la creazione dell'amministrato"
    );
    if (!result) return;
    setShowGuardianModal(false);
    setEditingGuardian(null);
    const shouldSelect = !editing || (selectedGuardian && selectedGuardian.id === editing.id);
    applyGuardianUpdate(result, { select: shouldSelect });
    setLastUpdated(new Date());
  };

  const deleteGuardian = async (g) => {
    if (!window.confirm("Eliminare questo amministrato?")) return;
    const success = await runOrAlert(
      () => fetchJson(`${API_BASE}/guardianships/${g.id}`, { method: "DELETE" }),
      "Errore durante l'eliminazione dell'amministrato"
    );
    if (!success) return;
    if (selectedGuardian && selectedGuardian.id === g.id) {
      setSelectedGuardian(null);
    }
    setGuardianships((prev) => prev.filter((item) => item.id !== g.id));
    setLastUpdated(new Date());
  };

  const submitGuardianDocument = async (e) => {
    e.preventDefault();
    if (!selectedGuardian) return;
    const editing = guardianEntryModal && guardianEntryModal.type === "document" ? guardianEntryModal.item : null;
    const form = e.target;
    const payload = {
      title: form.title.value.trim(),
      category: form.category.value.trim(),
      date: form.date.value,
      reference: form.reference.value.trim(),
      link: form.link.value.trim(),
      notes: form.notes.value
    };
    const endpoint = `${API_BASE}/guardianships/${selectedGuardian.id}/documents`;
    const url = editing ? `${endpoint}/${editing.id}` : endpoint;
    const method = editing ? "PUT" : "POST";
    const result = await runOrAlert(
      () =>
        fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      editing ? "Errore durante l'aggiornamento del documento" : "Errore durante l'aggiunta del documento"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setGuardianEntryModal(null);
    setLastUpdated(new Date());
  };

  const deleteGuardianDocument = async (doc) => {
    if (!selectedGuardian) return;
    if (!window.confirm("Eliminare questo documento dall'archivio?")) return;
    const result = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/guardianships/${selectedGuardian.id}/documents/${doc.id}`, {
          method: "DELETE"
        }),
      "Errore durante l'eliminazione del documento"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setLastUpdated(new Date());
  };

  const submitInventoryItem = async (e) => {
    e.preventDefault();
    if (!selectedGuardian) return;
    const editing = guardianEntryModal && guardianEntryModal.type === "inventory" ? guardianEntryModal.item : null;
    const form = e.target;
    const quantityValue = Number(form.quantity.value || 1);
    const totalValue = Number(form.value.value || 0);
    const payload = {
      label: form.label.value.trim(),
      category: form.category.value.trim(),
      location: form.location.value.trim(),
      quantity: Number.isFinite(quantityValue) ? quantityValue : 1,
      value: Number.isFinite(totalValue) ? totalValue : 0,
      notes: form.notes.value
    };
    const endpoint = `${API_BASE}/guardianships/${selectedGuardian.id}/inventory`;
    const url = editing ? `${endpoint}/${editing.id}` : endpoint;
    const method = editing ? "PUT" : "POST";
    const result = await runOrAlert(
      () =>
        fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      editing ? "Errore durante l'aggiornamento dell'inventario" : "Errore durante l'inserimento del bene"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setGuardianEntryModal(null);
    setLastUpdated(new Date());
  };

  const deleteInventoryItem = async (item) => {
    if (!selectedGuardian) return;
    if (!window.confirm("Rimuovere questa voce dall'inventario?")) return;
    const result = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/guardianships/${selectedGuardian.id}/inventory/${item.id}`, {
          method: "DELETE"
        }),
      "Errore durante la rimozione del bene"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setLastUpdated(new Date());
  };

  const submitGuardianMovement = async (e) => {
    e.preventDefault();
    if (!selectedGuardian) return;
    const editing = guardianEntryModal && guardianEntryModal.type === "movement" ? guardianEntryModal.item : null;
    const form = e.target;
    const amountValue = Number(form.amount.value);
    if (!Number.isFinite(amountValue)) {
      alert("Inserisci un importo numerico valido.");
      return;
    }
    const payload = {
      type: form.type.value,
      amount: amountValue,
      date: form.date.value,
      category: form.category.value.trim(),
      description: form.description.value.trim(),
      reference: form.reference.value.trim(),
      notes: form.notes.value
    };
    const endpoint = `${API_BASE}/guardianships/${selectedGuardian.id}/movements`;
    const url = editing ? `${endpoint}/${editing.id}` : endpoint;
    const method = editing ? "PUT" : "POST";
    const result = await runOrAlert(
      () =>
        fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      editing ? "Errore durante l'aggiornamento del movimento" : "Errore durante l'inserimento del movimento"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setGuardianEntryModal(null);
    setLastUpdated(new Date());
  };

  const deleteGuardianMovement = async (movement) => {
    if (!selectedGuardian) return;
    if (!window.confirm("Eliminare questa movimentazione economica?")) return;
    const result = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/guardianships/${selectedGuardian.id}/movements/${movement.id}`, {
          method: "DELETE"
        }),
      "Errore durante l'eliminazione del movimento"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setLastUpdated(new Date());
  };

  const submitGuardianReport = async (e) => {
    e.preventDefault();
    if (!selectedGuardian) return;
    const editing = guardianEntryModal && guardianEntryModal.type === "report" ? guardianEntryModal.item : null;
    const form = e.target;
    const payload = {
      title: form.title.value.trim(),
      periodStart: form.periodStart.value,
      periodEnd: form.periodEnd.value,
      deliveredAt: form.deliveredAt.value,
      status: form.status.value,
      protocol: form.protocol.value.trim(),
      attachment: form.attachment.value.trim(),
      summary: form.summary.value,
      notes: form.notes.value
    };
    const endpoint = `${API_BASE}/guardianships/${selectedGuardian.id}/reports`;
    const url = editing ? `${endpoint}/${editing.id}` : endpoint;
    const method = editing ? "PUT" : "POST";
    const result = await runOrAlert(
      () =>
        fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      editing ? "Errore durante l'aggiornamento del rendiconto" : "Errore durante la registrazione del rendiconto"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setGuardianEntryModal(null);
    setLastUpdated(new Date());
  };

  const deleteGuardianReport = async (report) => {
    if (!selectedGuardian) return;
    if (!window.confirm("Eliminare questo rendiconto?")) return;
    const result = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/guardianships/${selectedGuardian.id}/reports/${report.id}`, {
          method: "DELETE"
        }),
      "Errore durante l'eliminazione del rendiconto"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setLastUpdated(new Date());
  };

  const submitGuardianFiling = async (e) => {
    e.preventDefault();
    if (!selectedGuardian) return;
    const editing = guardianEntryModal && guardianEntryModal.type === "filing" ? guardianEntryModal.item : null;
    const form = e.target;
    const payload = {
      subject: form.subject.value.trim(),
      date: form.date.value,
      channel: form.channel.value.trim(),
      registry: form.registry.value.trim(),
      protocol: form.protocol.value.trim(),
      outcome: form.outcome.value.trim(),
      attachment: form.attachment.value.trim(),
      notes: form.notes.value
    };
    const endpoint = `${API_BASE}/guardianships/${selectedGuardian.id}/filings`;
    const url = editing ? `${endpoint}/${editing.id}` : endpoint;
    const method = editing ? "PUT" : "POST";
    const result = await runOrAlert(
      () =>
        fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      editing ? "Errore durante l'aggiornamento del deposito" : "Errore durante la registrazione del deposito"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setGuardianEntryModal(null);
    setLastUpdated(new Date());
  };

  const deleteGuardianFiling = async (filing) => {
    if (!selectedGuardian) return;
    if (!window.confirm("Eliminare questo deposito telematico?")) return;
    const result = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/guardianships/${selectedGuardian.id}/filings/${filing.id}`, {
          method: "DELETE"
        }),
      "Errore durante l'eliminazione del deposito"
    );
    if (!result) return;
    applyGuardianUpdate(result, { select: true });
    setLastUpdated(new Date());
  };

  // FATTURE ---------------------------------------------------
  const submitNewInvoice = async (e) => {
    e.preventDefault();
    const form = e.target;
    const payload = {
      clientId: form.clientId.value || null,
      caseId: form.caseId.value || null,
      date: form.date.value,
      notes: form.notes.value,
      manualLines: form.desc.value
        ? [{ description: form.desc.value, amount: Number(form.amount.value || 0) }]
        : []
    };
    const success = await runOrAlert(
      () =>
        fetchJson(`${API_BASE}/invoices`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }),
      "Errore durante la creazione della fattura"
    );
    if (!success) return;
    setShowNewInvoice(false);
    await loadAll();
  };

  const deleteInvoice = async (inv) => {
    if (!window.confirm("Eliminare questa fattura?")) return;
    const success = await runOrAlert(
      () => fetchJson(`${API_BASE}/invoices/${inv.id}`, { method: "DELETE" }),
      "Errore durante l'eliminazione della fattura"
    );
    if (success) {
      await loadAll();
    }
  };

  // EXPORT -----------------------------------------------------
  const doExport = (what) => {
    window.open(`${API_BASE}/export/${what}.csv`, "_blank");
  };

  const doExportExcel = () => {
    window.open(`${API_BASE}/export/excel`, "_blank");
  };

  // IMPORT -----------------------------------------------------
  const doImport = async (e) => {
    e.preventDefault();
    if (!importFile) {
      alert("Seleziona un file CSV prima");
      return;
    }
    try {
      const fd = new FormData();
      fd.append("file", importFile); // deve chiamarsi "file"
      const res = await fetch(`${API_BASE}/import/${importType}`, {
        method: "POST",
        body: fd
      });
      if (!res.ok) {
        const txt = await res.text();
        alert("Errore import: " + txt);
        return;
      }
      let data;
      try {
        data = await res.json();
      } catch (err) {
        alert("Import completato (risposta non JSON)");
        await loadAll();
        return;
      }
      alert(`Import OK: ${data.imported} record per ${data.type}`);
      await loadAll();
    } catch (err) {
      alert("Errore di rete: " + err.message);
    }
  };

  // handler calendario: mese precedente / successivo
  const goPrevMonth = () => {
    if (calendarMonth === 0) {
      setCalendarMonth(11);
      setCalendarYear((y) => y - 1);
    } else {
      setCalendarMonth((m) => m - 1);
    }
  };
  const goNextMonth = () => {
    if (calendarMonth === 11) {
      setCalendarMonth(0);
      setCalendarYear((y) => y + 1);
    } else {
      setCalendarMonth((m) => m + 1);
    }
  };

  // se non autenticato ‚Üí login
  if (!user) {
    return (
      <div
        style={{
          ...pageStyle,
          display: "flex",
          alignItems: "center",
          justifyContent: "center"
        }}
      >
        <form
          onSubmit={doLogin}
          style={{
            background: "#fff",
            padding: 24,
            borderRadius: 12,
            width: 320,
            boxShadow: "0 10px 30px rgba(0,0,0,0.08)"
          }}
        >
          <h2>Gestionale Studio Legale</h2>
          <p style={{ fontSize: 12, color: "#6b7280" }}>Accedi (admin / admin)</p>
          <label>
            Utente
            <br />
            <input
              value={loginUser}
              onChange={(e) => setLoginUser(e.target.value)}
              style={{ width: "100%", marginBottom: 8 }}
            />
          </label>
          <label>
            Password
            <br />
            <input
              type="password"
              value={loginPass}
              onChange={(e) => setLoginPass(e.target.value)}
              style={{ width: "100%", marginBottom: 8 }}
            />
          </label>
          {loginError && <p style={{ color: "red" }}>{loginError}</p>}
          <button type="submit" style={btn}>
            Entra
          </button>
        </form>
      </div>
    );
  }

  return (
    <div style={pageStyle}>
      {/* TOPBAR */}
      <header style={topbarStyle}>
        <div>
          <b>{studio ? studio.name : "Studio Legale"}</b>
          {studio && (
            <div style={{ fontSize: 12, color: "#9ca3af" }}>
              {studio.email}
              {studio.phone ? ` ¬∑ ${studio.phone}` : ""}
            </div>
          )}
          {lastUpdated && (
            <div style={{ fontSize: 11, color: "#9ca3af", marginTop: 4 }}>
              Ultimo aggiornamento: {formatDateTime(lastUpdated)}
            </div>
          )}
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          {loadError && (
            <span style={{ fontSize: 12, color: "#fbbf24" }}>
              {loadError}
            </span>
          )}
          <button
            onClick={loadAll}
            disabled={isLoading}
            style={{
              ...btn,
              background: "#1f2937",
              opacity: isLoading ? 0.6 : 1,
              cursor: isLoading ? "default" : "pointer"
            }}
          >
            {isLoading ? "Aggiornamento..." : "Aggiorna"}
          </button>
          <button onClick={() => setUser(null)} style={{ ...btn, background: "#ef4444" }}>
            Esci
          </button>
        </div>
      </header>

      {/* LAYOUT */}
      <div style={mainStyle}>
        {/* SIDEBAR */}
        <aside style={sidebarStyle}>
          <div style={{ marginBottom: 14, fontWeight: 600, fontSize: 13, color: "#6b7280" }}>Menu</div>
          <button onClick={() => setView("dashboard")} style={navBtn(view === "dashboard")}>
            Dashboard
          </button>
          <button onClick={() => setView("clients")} style={navBtn(view === "clients")}> 
            Clienti
          </button>
          <button onClick={() => setView("cases")} style={navBtn(view === "cases")}> 
            Pratiche
          </button>
          <button onClick={() => setView("guardianships")} style={navBtn(view === "guardianships")}> 
            Amministrati (AdS)
          </button>
          <button onClick={() => setView("invoices")} style={navBtn(view === "invoices")}> 
            Fatture
          </button>
          <button onClick={() => setView("deadlines")} style={navBtn(view === "deadlines")}>
            Scadenze / Udienze
          </button>
          <button onClick={() => setView("studio")} style={navBtn(view === "studio")}>
            Dati studio
          </button>
          <button onClick={() => setView("import-export")} style={navBtn(view === "import-export")}>
            Import / Export
          </button>
        </aside>

        {/* CONTENT */}
        <main style={{ flex: 1, padding: 20, overflowY: "auto" }}>
          {isLoading && (
            <div
              style={{
                marginBottom: 16,
                background: "#dbeafe",
                color: "#1d4ed8",
                padding: "8px 12px",
                borderRadius: 8,
                fontSize: 13
              }}
            >
              ‚è≥ Aggiornamento dati in corso...
            </div>
          )}
          {loadError && (
            <div
              style={{
                marginBottom: 16,
                background: "#fee2e2",
                color: "#b91c1c",
                padding: "10px 12px",
                borderRadius: 8,
                fontSize: 13,
                display: "flex",
                alignItems: "center",
                gap: 12,
                flexWrap: "wrap"
              }}
            >
              <span>‚ö†Ô∏è {loadError}</span>
              <button
                onClick={loadAll}
                style={{
                  ...btn,
                  background: "#991b1b",
                  padding: "4px 10px",
                  fontSize: 12
                }}
              >
                Riprova
              </button>
            </div>
          )}
          {/* DASHBOARD */}
          {view === "dashboard" && (
            <>
              <h1>Dashboard</h1>
              <div style={{ display: "flex", gap: 16, flexWrap: "wrap" }}>
                <DashCard title="Clienti" value={dashboard ? dashboard.totalClients : "..."} />
                <DashCard title="Pratiche" value={dashboard ? dashboard.totalCases : "..."} />
                <DashCard title="Pratiche aperte" value={dashboard ? dashboard.totalOpenCases : "..."} />
                <DashCard title="Fatturato" value={dashboard ? euro(dashboard.invoicesAmount) : "..."} />
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1.1fr 0.9fr", gap: 20, marginTop: 20 }}>
                <div style={card}>
                  <CalendarView
                    items={deadlines}
                    year={calendarYear}
                    month={calendarMonth}
                    onSelectDeadline={(d) => setEditDeadline(d)}
                    onPrev={goPrevMonth}
                    onNext={goNextMonth}
                    onYearChange={setCalendarYear}
                    onMonthChange={setCalendarMonth}
                  />
                </div>
                <div style={card}>
                  <h3>Scadenze imminenti (15gg)</h3>
                  <ul style={{ listStyle: "none", padding: 0, maxHeight: 300, overflowY: "auto" }}>
                    {upcoming.map((u) => (
                      <li
                        key={u.id}
                        style={{
                          background: statusColor(u.type || ""),
                          marginBottom: 6,
                          borderRadius: 6,
                          padding: 6
                        }}
                      >
                        <b>{u.date}</b> ‚Äì {u.type} ‚Äì {u.description}{" "}
                        <button onClick={() => setEditDeadline(u)}>‚úèÔ∏è</button>{" "}
                        <button onClick={() => deleteDeadline(u)}>üóëÔ∏è</button>
                        {u.caseNumber && (
                          <div style={{ fontSize: 11 }}>
                            Pratica: {u.caseNumber} ‚Äì {u.caseSubject}
                          </div>
                        )}
                      </li>
                    ))}
                    {upcoming.length === 0 && <li>Nessuna scadenza</li>}
                  </ul>
                  <hr />
                  <h4>Export rapido</h4>
                  <button
                    onClick={() => doExport("clients")}
                    style={{ ...btn, marginRight: 6, marginBottom: 4 }}
                  >
                    Clienti CSV
                  </button>
                  <button
                    onClick={() => doExport("cases")}
                    style={{ ...btn, marginRight: 6, marginBottom: 4 }}
                  >
                    Pratiche CSV
                  </button>
                  <button
                    onClick={() => doExport("invoices")}
                    style={{ ...btn, marginRight: 6, marginBottom: 4 }}
                  >
                    Fatture CSV
                  </button>
                  <button onClick={doExportExcel} style={{ ...btn, background: "#0f766e" }}>
                    Excel completo
                  </button>
                  {monthly && (
                    <>
                      <h4 style={{ marginTop: 10 }}>Statistiche mese</h4>
                      <p>
                        Pratiche create: <b>{monthly.casesThisMonth}</b>
                      </p>
                      <p>
                        Fatture emesse: <b>{monthly.invoicesThisMonth}</b>
                      </p>
                      <p>
                        Importo fatture: <b>{euro(monthly.invoicesAmountThisMonth)}</b>
                      </p>
                    </>
                  )}
                </div>
              </div>
            </>
          )}

          {/* CLIENTI */}
          {view === "clients" && (
            <>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <h1>Clienti</h1>
                <div>
                  <button
                    style={{ ...btn, marginRight: 6 }}
                    onClick={() => doExport("clients")}
                  >
                    Export CSV
                  </button>
                  <button style={btn} onClick={() => setShowNewClient(true)}>
                    + Nuovo cliente
                  </button>
                </div>
              </div>
              <div style={card}>
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: 12,
                    marginBottom: 12,
                    flexWrap: "wrap"
                  }}
                >
                  <input
                    type="search"
                    placeholder="Cerca per nome, email o telefono"
                    value={clientQuery}
                    onChange={(e) => setClientQuery(e.target.value)}
                    style={searchInput}
                  />
                  {clientQuery && (
                    <button
                      onClick={() => setClientQuery("")}
                      style={{ ...btn, background: "#6b7280", padding: "6px 10px" }}
                    >
                      Pulisci filtro
                    </button>
                  )}
                  <span style={{ fontSize: 12, color: "#6b7280" }}>
                    {filteredClients.length} risultati
                  </span>
                </div>
                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead>
                    <tr style={{ textAlign: "left" }}>
                      <th>Nome</th>
                      <th>Email</th>
                      <th>Telefono</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredClients.map((cl) => (
                      <tr key={cl.id} style={{ borderBottom: "1px solid #e5e7eb" }}>
                        <td>{cl.name}</td>
                        <td>{cl.email}</td>
                        <td>{cl.phone}</td>
                        <td>
                          <button onClick={() => editClient(cl)}>‚úèÔ∏è</button>{" "}
                          <button onClick={() => deleteClient(cl)}>üóëÔ∏è</button>
                        </td>
                      </tr>
                    ))}
                    {filteredClients.length === 0 && (
                      <tr>
                        <td colSpan="4">Nessun cliente</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              <div style={card}>
                <h3>Sincronizza con Calendario Apple</h3>
                <p style={{ fontSize: 13, color: "#4b5563" }}>
                  Iscriviti al calendario delle scadenze su Mac o iPhone per ricevere
                  automaticamente ogni aggiornamento. Su <b>Mac</b> apri l'app Calendario e scegli
                  <i>File ‚Üí Nuova iscrizione al calendario...</i>; su <b>iPhone</b> vai in
                  <i>Impostazioni ‚Üí Calendario ‚Üí Account ‚Üí Aggiungi account ‚Üí Altro ‚Üí Aggiungi calendario
                  sottoscritto</i> e incolla il link qui sotto.
                </p>
                <div
                  style={{
                    margin: "12px 0",
                    padding: "10px 12px",
                    background: "#f9fafb",
                    border: "1px solid #e5e7eb",
                    borderRadius: 8,
                    fontFamily: "SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
                    fontSize: 13,
                    wordBreak: "break-all"
                  }}
                >
                  {calendarFeedUrl}
                </div>
                <div style={{ display: "flex", flexWrap: "wrap", gap: 8, alignItems: "center" }}>
                  <button onClick={copyCalendarLink} style={{ ...btn, background: "#0f766e" }}>
                    Copia link
                  </button>
                  {calendarSubscribeUrl && (
                    <a
                      href={calendarSubscribeUrl}
                      style={{ ...btn, display: "inline-block", textDecoration: "none" }}
                      target="_blank"
                      rel="noreferrer"
                    >
                      Apri in Calendario
                    </a>
                  )}
                  {calendarCopyStatus && (
                    <span style={{ fontSize: 12, color: "#047857" }}>{calendarCopyStatus}</span>
                  )}
                </div>
                <p style={{ fontSize: 12, color: "#6b7280", marginTop: 12 }}>
                  Se utilizzi il gestionale in rete locale, assicurati che l'indirizzo sopra sia raggiungibile
                  anche da iPhone e Mac (es. sostituendo <code>localhost</code> con l'indirizzo IP del computer).
                </p>
              </div>
            </>
          )}

          {/* PRATICHE */}
          {view === "cases" && (
            <>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <h1>Pratiche</h1>
                <div>
                  <button
                    style={{ ...btn, marginRight: 6 }}
                    onClick={() => doExport("cases")}
                  >
                    Export CSV
                  </button>
                  <button style={btn} onClick={() => setShowNewCase(true)}>
                    + Nuova pratica
                  </button>
                </div>
              </div>
              <div style={card}>
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: 12,
                    marginBottom: 12,
                    flexWrap: "wrap"
                  }}
                >
                  <input
                    type="search"
                    placeholder="Cerca per numero, oggetto o cliente"
                    value={caseQuery}
                    onChange={(e) => setCaseQuery(e.target.value)}
                    style={{ ...searchInput, minWidth: 260 }}
                  />
                  <label style={{ fontSize: 12, color: "#6b7280" }}>
                    Stato:
                    <select
                      value={caseStatusFilter}
                      onChange={(e) => setCaseStatusFilter(e.target.value)}
                      style={{ marginLeft: 6, padding: "6px 8px", borderRadius: 6, border: "1px solid #d1d5db" }}
                    >
                      <option value="all">Tutte</option>
                      <option value="aperta">Aperte</option>
                      <option value="chiusa">Chiuse</option>
                    </select>
                  </label>
                  <span style={{ fontSize: 12, color: "#6b7280" }}>
                    {filteredCases.length} risultati
                  </span>
                </div>
                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead>
                    <tr>
                      <th>Numero</th>
                      <th>Oggetto</th>
                      <th>Cliente</th>
                      <th>Tipo</th>
                      <th>Procedimento</th>
                      <th>Stato</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredCases.map((c) => (
                      <tr
                        key={c.id}
                        style={{ borderBottom: "1px solid #e5e7eb", cursor: "pointer" }}
                        onClick={() => openCase(c)}
                      >
                        <td>{c.number}</td>
                        <td>{c.subject}</td>
                        <td>{c.clientName}</td>
                        <td>{c.caseType}</td>
                        <td>{c.proceedingType}</td>
                        <td>{c.status}</td>
                        <td>
                          <button
                            onClick={(ev) => {
                              ev.stopPropagation();
                              editCase(c);
                            }}
                          >
                            ‚úèÔ∏è
                          </button>{" "}
                          <button
                            onClick={(ev) => {
                              ev.stopPropagation();
                              deleteCase(c);
                            }}
                          >
                            üóëÔ∏è
                          </button>
                        </td>
                      </tr>
                    ))}
                    {filteredCases.length === 0 && (
                      <tr>
                        <td colSpan="7">Nessuna pratica</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </>
          )}

          {/* DETTAGLIO PRATICA */}
          {view === "case-detail" && selectedCase && (
            <>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <h1>Pratica {selectedCase.number}</h1>
                <div>
                  <button onClick={() => editCase(selectedCase)} style={{ ...btn, marginRight: 8 }}>
                    Modifica
                  </button>
                  <button onClick={() => deleteCase(selectedCase)} style={{ ...btn, background: "#ef4444" }}>
                    Elimina
                  </button>
                </div>
              </div>
              <div style={{ display: "grid", gridTemplateColumns: "1.1fr 0.9fr", gap: 20 }}>
                <div>
                  <div style={card}>
                    <h3>Dati pratica</h3>
                    <p>
                      <b>Oggetto:</b> {selectedCase.subject}
                    </p>
                    <p>
                      <b>Cliente:</b> {selectedCase.client ? selectedCase.client.name : "-"}
                    </p>
                    <p>
                      <b>Tipo:</b> {selectedCase.caseType}
                    </p>
                    <p>
                      <b>Procedimento:</b> {selectedCase.proceedingType}
                    </p>
                    {selectedCase.proceedingType === "giudiziale" && (
                      <>
                        <p>
                          <b>Tribunale:</b> {selectedCase.court || "-"}
                        </p>
                        <p>
                          <b>RG:</b> {selectedCase.rgNumber || "-"}
                        </p>
                      </>
                    )}
                  </div>
                  <div style={card}>
                    <h3>Scadenze collegate</h3>
                    <button style={{ ...btn, marginBottom: 8 }} onClick={() => setShowNewDeadline(true)}>
                      + Aggiungi scadenza/udienza
                    </button>
                    <ul style={{ listStyle: "none", padding: 0 }}>
                      {selectedCase.deadlines && selectedCase.deadlines.length > 0 ? (
                        selectedCase.deadlines.map((d) => (
                          <li
                            key={d.id}
                            style={{
                              background: statusColor(d.type || ""),
                              padding: 6,
                              borderRadius: 6,
                              marginBottom: 4
                            }}
                          >
                            <b>{d.date}</b> ‚Äì {d.type} ‚Äì {d.description}{" "}
                            <button onClick={() => setEditDeadline(d)}>‚úèÔ∏è</button>{" "}
                            <button onClick={() => deleteDeadline(d)}>üóëÔ∏è</button>
                          </li>
                        ))
                      ) : (
                        <li>Nessuna scadenza</li>
                      )}
                    </ul>
                  </div>
                  <div style={card}>
                    <h3>Fatture collegate</h3>
                    <ul>
                      {selectedCase.invoices && selectedCase.invoices.length > 0 ? (
                        selectedCase.invoices.map((inv) => (
                          <li key={inv.id}>
                            {inv.number} ‚Äì {inv.date} ‚Äì{" "}
                            {inv.totals ? euro(inv.totals.totale) : "-"}{" "}
                            <button onClick={() => deleteInvoice(inv)}>üóëÔ∏è</button>{" "}
                            <a
                              href={`${API_BASE}/invoices/${inv.id}/pdf`}
                              target="_blank"
                              rel="noreferrer"
                            >
                              üìÑ
                            </a>
                          </li>
                        ))
                      ) : (
                        <li>Nessuna fattura</li>
                      )}
                    </ul>
                  </div>
                </div>
                <div>
                  <div style={card}>
                    <h3>Cronostoria</h3>
                    <div style={{ maxHeight: 250, overflowY: "auto", marginBottom: 10 }}>
                      {caseLogs.length > 0 ? (
                        caseLogs.map((l) => (
                          <div key={l.id} style={{ marginBottom: 6 }}>
                            <div style={{ fontSize: 11, color: "#6b7280" }}>
                              {new Date(l.createdAt).toLocaleString()}
                            </div>
                            <div>
                              <b>{l.action}</b> ‚Äì {l.detail}
                            </div>
                          </div>
                        ))
                      ) : (
                        <p>Nessun evento registrato</p>
                      )}
                    </div>
                    <textarea
                      value={newCaseNote}
                      onChange={(e) => setNewCaseNote(e.target.value)}
                      style={{ width: "100%", minHeight: 60 }}
                      placeholder="Aggiungi nota (es. telefonata col cliente)"
                    />
                    <button style={{ ...btn, marginTop: 6 }} onClick={addManualNote}>
                      Aggiungi nota
                    </button>
                  </div>
                  <div style={card}>
                    <h3>Riepilogo economico</h3>
                    <p>
                      Spese sostenute: <b>{euro(selectedCase.summary?.totalExpenses || 0)}</b>
                    </p>
                    <p>
                      Fatture emesse: <b>{euro(selectedCase.summary?.totalInvoices || 0)}</b>
                    </p>
                    <p>
                      Tempo attivit√†: <b>{selectedCase.summary?.totalMinutes || 0}</b> minuti
                    </p>
                  </div>
                </div>
              </div>
            </>
          )}

          {/* FATTURE */}
          {view === "invoices" && (
            <>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <h1>Fatture</h1>
                <div>
                  <button
                    style={{ ...btn, marginRight: 6 }}
                    onClick={() => doExport("invoices")}
                  >
                    Export CSV
                  </button>
                  <button style={btn} onClick={() => setShowNewInvoice(true)}>
                    + Nuova fattura
                  </button>
                </div>
              </div>
              <div style={card}>
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: 12,
                    marginBottom: 12,
                    flexWrap: "wrap"
                  }}
                >
                  <input
                    type="search"
                    placeholder="Cerca per numero, cliente o pratica"
                    value={invoiceQuery}
                    onChange={(e) => setInvoiceQuery(e.target.value)}
                    style={{ ...searchInput, minWidth: 260 }}
                  />
                  <span style={{ fontSize: 12, color: "#6b7280" }}>
                    {filteredInvoices.length} risultati
                  </span>
                </div>
                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead>
                    <tr>
                      <th>Numero</th>
                      <th>Data</th>
                      <th>Cliente</th>
                      <th>Pratica</th>
                      <th>Totale</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredInvoices.map((inv) => (
                      <tr key={inv.id} style={{ borderBottom: "1px solid #e5e7eb" }}>
                        <td>{inv.number}</td>
                        <td>{inv.date}</td>
                        <td>{inv.clientName}</td>
                        <td>{inv.caseNumber}</td>
                        <td>{inv.totals ? euro(inv.totals.totale) : "-"}</td>
                        <td>
                          <a
                            href={`${API_BASE}/invoices/${inv.id}/pdf`}
                            target="_blank"
                            rel="noreferrer"
                          >
                            üìÑ
                          </a>{" "}
                          <button onClick={() => deleteInvoice(inv)}>üóëÔ∏è</button>
                        </td>
                      </tr>
                    ))}
                    {filteredInvoices.length === 0 && (
                      <tr>
                        <td colSpan="6">Nessuna fattura</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </>
          )}

          {/* SCADENZE */}
          {view === "deadlines" && (
            <>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <h1>Scadenze / Udienze</h1>
                <button style={btn} onClick={() => setShowNewDeadline(true)}>
                  + Nuova scadenza
                </button>
              </div>
              <div style={card}>
                <div
                  style={{
                    display: "flex",
                    justifyContent: "space-between",
                    alignItems: "center",
                    gap: 12,
                    marginBottom: 12,
                    flexWrap: "wrap"
                  }}
                >
                  <input
                    type="search"
                    placeholder="Cerca per descrizione o pratica"
                    value={deadlineQuery}
                    onChange={(e) => setDeadlineQuery(e.target.value)}
                    style={{ ...searchInput, minWidth: 260 }}
                  />
                  <label style={{ fontSize: 12, color: "#6b7280" }}>
                    Tipo:
                    <select
                      value={deadlineTypeFilter}
                      onChange={(e) => setDeadlineTypeFilter(e.target.value)}
                      style={{ marginLeft: 6, padding: "6px 8px", borderRadius: 6, border: "1px solid #d1d5db" }}
                    >
                      <option value="all">Tutti</option>
                      <option value="udienza">Udienze</option>
                      <option value="scadenza">Scadenze</option>
                      <option value="termine">Termini</option>
                    </select>
                  </label>
                  <span style={{ fontSize: 12, color: "#6b7280" }}>
                    {filteredDeadlines.length} risultati
                  </span>
                </div>
                <table style={{ width: "100%", borderCollapse: "collapse" }}>
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Tipo</th>
                      <th>Descrizione</th>
                      <th>Pratica</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {filteredDeadlines.map((d) => {
                      const cas = casesById.get(d.caseId);
                      return (
                        <tr key={d.id} style={{ borderBottom: "1px solid #e5e7eb" }}>
                          <td>{d.date}</td>
                          <td>{d.type}</td>
                          <td>{d.description}</td>
                          <td>{cas ? `${cas.number} - ${cas.subject}` : ""}</td>
                          <td>
                            <button onClick={() => setEditDeadline(d)}>‚úèÔ∏è</button>{" "}
                            <button onClick={() => deleteDeadline(d)}>üóëÔ∏è</button>
                          </td>
                        </tr>
                      );
                    })}
                    {filteredDeadlines.length === 0 && (
                      <tr>
                        <td colSpan="5">Nessuna scadenza</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </>
          )}

          {/* DATI STUDIO */}
          {view === "studio" && studio && (
            <>
              <h1>Dati studio (intestazione fatture)</h1>
              <div style={card}>
                <StudioForm studio={studio} onSaved={loadAll} />
              </div>
            </>
          )}

          {/* IMPORT / EXPORT */}
          {view === "import-export" && (
            <>
              <h1>Import / Export</h1>

              {/* EXPORT */}
              <div style={card}>
                <h3>Export</h3>
                <p style={{ fontSize: 12, color: "#6b7280" }}>
                  Scarica i dati attuali in formato CSV o Excel. Il CSV puoi poi riaprirlo e reimportarlo.
                </p>
                <button
                  onClick={() => doExport("clients")}
                  style={{ ...btn, marginRight: 6, marginBottom: 6 }}
                >
                  Clienti CSV
                </button>
                <button
                  onClick={() => doExport("cases")}
                  style={{ ...btn, marginRight: 6, marginBottom: 6 }}
                >
                  Pratiche CSV
                </button>
                <button
                  onClick={() => doExport("invoices")}
                  style={{ ...btn, marginRight: 6, marginBottom: 6 }}
                >
                  Fatture CSV
                </button>
                <button onClick={doExportExcel} style={{ ...btn, background: "#0f766e" }}>
                  Excel completo
                </button>
              </div>

              {/* IMPORT */}
              <div style={card}>
                <h3>Import da CSV</h3>
                <p style={{ fontSize: 12, color: "#6b7280" }}>
                  Consiglio: prima fai l‚Äôexport, aggiungi righe nel CSV, poi reimporti. Separatore: <b>;</b>.
                </p>
                <form onSubmit={doImport}>
                  <label>
                    Tipo da importare
                    <br />
                    <select value={importType} onChange={(e) => setImportType(e.target.value)}>
                      <option value="clients">Clienti</option>
                      <option value="cases">Pratiche</option>
                      <option value="invoices">Fatture</option>
                    </select>
                  </label>
                  <br />
                  <br />
                  <label>
                    File CSV
                    <br />
                    <input
                      type="file"
                      accept=".csv,text/csv"
                      onChange={(e) => {
                        const f = e.target.files && e.target.files[0] ? e.target.files[0] : null;
                        setImportFile(f);
                      }}
                    />
                  </label>
                  <br />
                  <br />
                  <button type="submit" style={btn}>
                    Importa
                  </button>
                </form>
                <p style={{ fontSize: 11, color: "#6b7280", marginTop: 10 }}>
                  Se non succede niente: controlla la console del browser (F12 ‚Üí Console) e la finestra del
                  backend (dove c‚Äô√® <code>npm start</code>).
                </p>
              </div>
            </>
          )}
        </main>
      </div>

      {/* MODALI -------------------------------------------------*/}

      {/* nuovo / modifica amministrato */}
      {showGuardianModal && (
        <Modal
          onClose={closeGuardianModal}
          title={editingGuardian ? "Modifica amministrato di sostegno" : "Nuovo amministrato di sostegno"}
        >
          <GuardianForm
            initialData={editingGuardian}
            onSubmit={submitGuardian}
            onCancel={closeGuardianModal}
          />
        </Modal>
      )}

      {/* nuovo cliente */}
      {showNewClient && (
        <Modal onClose={() => setShowNewClient(false)} title="Nuovo cliente">
          <form onSubmit={submitNewClient}>
            <label>
              Nome<br />
              <input name="name" required style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Codice fiscale<br />
              <input name="fiscalCode" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              P.IVA<br />
              <input name="vatNumber" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Email<br />
              <input name="email" type="email" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              PEC<br />
              <input name="pec" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Telefono<br />
              <input name="phone" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Indirizzo<br />
              <input name="address" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Note<br />
              <textarea name="notes" style={{ width: "100%" }} />
            </label>
            <br />
            <button type="submit" style={btn}>
              Salva
            </button>
          </form>
        </Modal>
      )}

      {/* nuova pratica */}
      {showNewCase && (
        <Modal onClose={() => setShowNewCase(false)} title="Nuova pratica">
          <form onSubmit={submitNewCase}>
            <label>
              Oggetto<br />
              <input name="subject" required style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Cliente<br />
              <select name="clientId" style={{ width: "100%" }}>
                <option value="">-- nessuno --</option>
                {clients.map((cl) => (
                  <option key={cl.id} value={cl.id}>
                    {cl.name}
                  </option>
                ))}
              </select>
            </label>
            <br />
            <label>
              Tipo pratica<br />
              <select name="caseType" style={{ width: "100%" }}>
                <option value="civile">Civile</option>
                <option value="penale">Penale</option>
                <option value="lavoro">Lavoro</option>
                <option value="amministrativo">Amministrativo</option>
                <option value="altro">Altro</option>
              </select>
            </label>
            <br />
            <label>
              Procedimento<br />
              <select name="proceedingType" defaultValue="stragiudiziale" style={{ width: "100%" }}>
                <option value="stragiudiziale">Stragiudiziale</option>
                <option value="giudiziale">Giudiziale</option>
              </select>
            </label>
            <br />
            <label>
              Tribunale (se giudiziale)<br />
              <input name="court" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Numero RG<br />
              <input name="rgNumber" style={{ width: "100%" }} />
            </label>
            <br />
            <button type="submit" style={btn}>
              Crea
            </button>
          </form>
        </Modal>
      )}

      {/* nuova fattura */}
      {showNewInvoice && (
        <Modal onClose={() => setShowNewInvoice(false)} title="Nuova fattura">
          <form onSubmit={submitNewInvoice}>
            <label>
              Cliente<br />
              <select name="clientId" style={{ width: "100%" }}>
                <option value="">-- nessuno --</option>
                {clients.map((cl) => (
                  <option key={cl.id} value={cl.id}>
                    {cl.name}
                  </option>
                ))}
              </select>
            </label>
            <br />
            <label>
              Pratica<br />
              <select name="caseId" style={{ width: "100%" }}>
                <option value="">-- nessuna --</option>
                {cases.map((c) => (
                  <option key={c.id} value={c.id}>
                    {c.number} - {c.subject}
                  </option>
                ))}
              </select>
            </label>
            <br />
            <label>
              Data<br />
              <input name="date" type="date" defaultValue={todayIso()} style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Voce manuale (concordato)<br />
              <input name="desc" style={{ width: "100%" }} placeholder="es. concordato per parere" />
            </label>
            <br />
            <label>
              Importo<br />
              <input name="amount" type="number" step="0.01" style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Note<br />
              <textarea name="notes" style={{ width: "100%" }} />
            </label>
            <br />
            <button type="submit" style={btn}>
              Emetti
            </button>
          </form>
        </Modal>
      )}

      {/* nuova scadenza */}
      {showNewDeadline && (
        <Modal onClose={() => setShowNewDeadline(false)} title="Nuova scadenza / udienza">
          <form onSubmit={submitNewDeadline}>
            <label>
              Pratica<br />
              <select name="caseId" style={{ width: "100%" }}>
                <option value="">-- seleziona --</option>
                {cases.map((c) => (
                  <option key={c.id} value={c.id}>
                    {c.number} - {c.subject}
                  </option>
                ))}
              </select>
            </label>
            <br />
            <label>
              Data<br />
              <input type="date" name="date" defaultValue={todayIso()} style={{ width: "100%" }} />
            </label>
            <br />
            <label>
              Tipo<br />
              <select name="type" style={{ width: "100%" }}>
                <option value="udienza">Udienza</option>
                <option value="scadenza">Scadenza</option>
                <option value="termine">Termine</option>
              </select>
            </label>
            <br />
            <label>
              Descrizione<br />
              <input name="description" style={{ width: "100%" }} />
            </label>
            <br />
            <button type="submit" style={btn}>
              Salva
            </button>
          </form>
        </Modal>
      )}

      {/* modifica scadenza */}
      {editDeadline && (
        <Modal onClose={() => setEditDeadline(null)} title="Modifica scadenza / udienza">
          <form onSubmit={updateDeadline}>
            <label>
              Data<br />
              <input
                type="date"
                name="date"
                defaultValue={editDeadline.date}
                style={{ width: "100%" }}
              />
            </label>
            <br />
            <label>
              Tipo<br />
              <select name="type" defaultValue={editDeadline.type} style={{ width: "100%" }}>
                <option value="udienza">Udienza</option>
                <option value="scadenza">Scadenza</option>
                <option value="termine">Termine</option>
              </select>
            </label>
            <br />
            <label>
              Descrizione<br />
              <input
                name="description"
                defaultValue={editDeadline.description}
                style={{ width: "100%" }}
              />
            </label>
            <br />
            <button type="submit" style={btn}>
              Aggiorna
            </button>{" "}
            <button
              type="button"
              onClick={() => deleteDeadline(editDeadline)}
              style={{ ...btn, background: "#ef4444" }}
            >
              Elimina
            </button>
          </form>
        </Modal>
      )}
    </div>
  );
}

// componenti di supporto
function navBtn(active) {
  return {
    width: "100%",
    textAlign: "left",
    background: active ? "#dbeafe" : "transparent",
    border: "none",
    padding: "6px 8px",
    borderRadius: 6,
    marginBottom: 4,
    cursor: "pointer"
  };
}

function DashCard({ title, value }) {
  return (
    <div style={{ ...card, minWidth: 160 }}>
      <div style={{ fontSize: 12, color: "#6b7280" }}>{title}</div>
      <div style={{ fontSize: 26, fontWeight: 700 }}>{value}</div>
    </div>
  );
}

function Modal({ children, onClose, title }) {
  return (
    <div
      style={{
        position: "fixed",
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: "rgba(0,0,0,0.3)",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        zIndex: 50
      }}
    >
      <div
        style={{
          background: "#fff",
          borderRadius: 10,
          padding: 20,
          width: 420,
          maxHeight: "90vh",
          overflowY: "auto"
        }}
      >
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
          <h2 style={{ margin: 0 }}>{title}</h2>
          <button
            onClick={onClose}
            style={{ border: "none", background: "transparent", fontSize: 20, cursor: "pointer" }}
          >
            √ó
          </button>
        </div>
        {children}
      </div>
    </div>
  );
}

function GuardianForm({ initialData, onSubmit, onCancel }) {
  const data = initialData || {};
  return (
    <form onSubmit={onSubmit}>
      <label>
        Nome e cognome<br />
        <input name="fullName" required defaultValue={data.fullName || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Stato amministrazione<br />
        <select name="status" defaultValue={data.status || "attivo"} style={{ width: "100%" }}>
          <option value="attivo">Attivo</option>
          <option value="chiuso">Chiuso</option>
          <option value="archiviato">Archiviato</option>
        </select>
      </label>
      <br />
      <label>
        Livello di supporto / progetto<br />
        <input name="supportLevel" defaultValue={data.supportLevel || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Data di nascita<br />
        <input name="birthDate" type="date" defaultValue={data.birthDate || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Codice fiscale<br />
        <input name="fiscalCode" defaultValue={data.fiscalCode || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Residenza<br />
        <input name="residence" defaultValue={data.residence || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Tribunale competente<br />
        <input name="court" defaultValue={data.court || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Giudice tutelare<br />
        <input name="judge" defaultValue={data.judge || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Data decreto di nomina<br />
        <input name="decreeDate" type="date" defaultValue={data.decreeDate || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Frequenza rendiconti (es. annuale, semestrale)<br />
        <input
          name="reportingFrequency"
          defaultValue={data.reportingFrequency || ""}
          style={{ width: "100%" }}
        />
      </label>
      <br />
      <label>
        Prossima scadenza rendiconto<br />
        <input name="nextReportDue" type="date" defaultValue={data.nextReportDue || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Ultimo rendiconto inviato<br />
        <input name="lastReportSent" type="date" defaultValue={data.lastReportSent || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Entrate, contributi e patrimonio<br />
        <input name="income" defaultValue={data.income || ""} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Contatto servizi sociali<br />
        <input
          name="socialServicesContact"
          defaultValue={data.socialServicesContact || ""}
          style={{ width: "100%" }}
        />
      </label>
      <br />
      <label>
        Familiari e riferimenti utili<br />
        <textarea
          name="familyContacts"
          defaultValue={data.familyContacts || ""}
          style={{ width: "100%", minHeight: 60 }}
        />
      </label>
      <br />
      <label>
        Note sanitarie<br />
        <textarea
          name="healthNotes"
          defaultValue={data.healthNotes || ""}
          style={{ width: "100%", minHeight: 60 }}
        />
      </label>
      <br />
      <label>
        Note operative aggiuntive<br />
        <textarea name="notes" defaultValue={data.notes || ""} style={{ width: "100%", minHeight: 80 }} />
      </label>
      <br />
      <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
        <button type="button" onClick={onCancel} style={{ ...btn, background: "#6b7280" }}>
          Annulla
        </button>
        <button type="submit" style={btn}>
          Salva
        </button>
      </div>
    </form>
  );
}

function StudioForm({ studio, onSaved }) {
  const [form, setForm] = useState(studio);

  useEffect(() => {
    setForm(studio);
  }, [studio]);

  const change = (k, v) => {
    setForm({ ...form, [k]: v });
  };

  const save = async (e) => {
    e.preventDefault();
    try {
      await fetchJson(`${API_BASE}/studio`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(form)
      });
      if (onSaved) onSaved();
    } catch (err) {
      alert(`Errore durante il salvataggio: ${err?.message || "riprovare"}`);
    }
  };

  return (
    <form onSubmit={save}>
      <label>
        Nome studio<br />
        <input value={form.name || ""} onChange={(e) => change("name", e.target.value)} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Indirizzo<br />
        <input
          value={form.address || ""}
          onChange={(e) => change("address", e.target.value)}
          style={{ width: "100%" }}
        />
      </label>
      <br />
      <label>
        Email<br />
        <input value={form.email || ""} onChange={(e) => change("email", e.target.value)} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        Telefono<br />
        <input value={form.phone || ""} onChange={(e) => change("phone", e.target.value)} style={{ width: "100%" }} />
      </label>
      <br />
      <label>
        P.IVA<br />
        <input
          value={form.vatNumber || ""}
          onChange={(e) => change("vatNumber", e.target.value)}
          style={{ width: "100%" }}
        />
      </label>
      <br />
      <label>
        Codice fiscale<br />
        <input
          value={form.fiscalCode || ""}
          onChange={(e) => change("fiscalCode", e.target.value)}
          style={{ width: "100%" }}
        />
      </label>
      <br />
      <label>
        Cassa (%)<br />
        <input
          type="number"
          value={form.cassaPerc ?? 0}
          onChange={(e) => change("cassaPerc", Number(e.target.value))}
        />
      </label>
      <br />
      <label>
        IVA (%)<br />
        <input
          type="number"
          value={form.ivaPerc ?? 0}
          onChange={(e) => change("ivaPerc", Number(e.target.value))}
        />
      </label>
      <br />
      <label>
        Ritenuta (%)<br />
        <input
          type="number"
          value={form.ritenutaPerc ?? 0}
          onChange={(e) => change("ritenutaPerc", Number(e.target.value))}
        />
      </label>
      <br />
      <label>
        Marca da bollo (‚Ç¨)<br />
        <input
          type="number"
          step="0.01"
          value={form.bollo ?? 0}
          onChange={(e) => change("bollo", Number(e.target.value))}
        />
      </label>
      <br />
      <button type="submit" style={btn}>
        Salva
      </button>
    </form>
  );
}

async function fetchJson(url, options = {}) {
  const res = await fetch(url, options);
  const text = await res.text();
  if (!res.ok) {
    let message = text.trim();
    if (!message) {
      message = `Errore ${res.status}`;
    } else {
      try {
        const data = JSON.parse(message);
        if (data && typeof data === "object") {
          if (data.message) {
            message = data.message;
          } else {
            message = JSON.stringify(data);
          }
        }
      } catch (err) {
        // testo non JSON, mantengo message
      }
    }
    throw new Error(message);
  }
  const trimmed = text.trim();
  if (!trimmed) return null;
  try {
    return JSON.parse(trimmed);
  } catch (err) {
    return trimmed;
  }
}

function normalizeText(value) {
  if (value === null || value === undefined) return "";
  return value
    .toString()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function formatDateTime(value) {
  if (!value) return "";
  const date = value instanceof Date ? value : new Date(value);
  if (Number.isNaN(date.getTime())) return "";
  return new Intl.DateTimeFormat("it-IT", { dateStyle: "short", timeStyle: "short" }).format(date);
}

// helper
function euro(v) {
  return new Intl.NumberFormat("it-IT", { style: "currency", currency: "EUR" }).format(v);
}

function todayIso() {
  return new Date().toISOString().slice(0, 10);
}

// calendario riutilizzabile
function CalendarView({ items, year, month, onSelectDeadline, onPrev, onNext, onYearChange, onMonthChange }) {
  // items: array di { date: "YYYY-MM-DD", ... }

  const first = new Date(year, month, 1);
  const startDay = first.getDay() === 0 ? 7 : first.getDay(); // lun=1 ... dom=7
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const cells = [];
  for (let i = 1; i < startDay; i++) cells.push(null);
  for (let d = 1; d <= daysInMonth; d++) cells.push(d);
  const monthStr = `${year}-${String(month + 1).padStart(2, "0")}`;

  const monthNames = [
    "Gennaio",
    "Febbraio",
    "Marzo",
    "Aprile",
    "Maggio",
    "Giugno",
    "Luglio",
    "Agosto",
    "Settembre",
    "Ottobre",
    "Novembre",
    "Dicembre"
  ];

  // filtra items per questo mese (cos√¨ non cicliamo tutto sotto)
  const monthItems = items.filter((it) => it.date && it.date.startsWith(monthStr));

  // per la select anni faccio un range semplice
  const years = [];
  const currentYear = new Date().getFullYear();
  for (let y = currentYear - 3; y <= currentYear + 3; y++) years.push(y);

  return (
    <div>
      {/* toolbar calendario */}
      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8, gap: 8 }}>
        <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
          <button onClick={onPrev} style={{ ...btn, padding: "2px 10px" }}>
            ‚óÄ
          </button>
          <button onClick={onNext} style={{ ...btn, padding: "2px 10px" }}>
            ‚ñ∂
          </button>
          <select value={month} onChange={(e) => onMonthChange(Number(e.target.value))}>
            {monthNames.map((m, idx) => (
              <option key={m} value={idx}>
                {m}
              </option>
            ))}
          </select>
          <select value={year} onChange={(e) => onYearChange(Number(e.target.value))}>
            {years.map((y) => (
              <option key={y} value={y}>
                {y}
              </option>
            ))}
          </select>
        </div>
        <div style={{ display: "flex", gap: 8, fontSize: 11, alignItems: "center" }}>
          <span style={{ width: 12, height: 12, background: "#fee2e2", display: "inline-block" }} /> udienza
          <span style={{ width: 12, height: 12, background: "#e0f2fe", display: "inline-block" }} /> scadenza
          <span style={{ width: 12, height: 12, background: "#fef9c3", display: "inline-block" }} /> termine
        </div>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(7, 1fr)", gap: 4 }}>
        {["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"].map((d) => (
          <div key={d} style={{ fontSize: 11, textAlign: "center", color: "#6b7280" }}>
            {d}
          </div>
        ))}
        {cells.map((d, i) => {
          const dayStr = d ? `${monthStr}-${String(d).padStart(2, "0")}` : null;
          const dayItems = d ? monthItems.filter((it) => it.date === dayStr) : [];
          return (
            <div
              key={i}
              style={{
                minHeight: 70,
                background: "#f9fafb",
                borderRadius: 8,
                padding: 4,
                border: "1px solid #e5e7eb",
                fontSize: 11
              }}
            >
              <div style={{ textAlign: "right", fontWeight: 500, marginBottom: 4 }}>{d || ""}</div>
              {dayItems.map((it) => (
                <div
                    key={it.id}
                    onClick={() => onSelectDeadline(it)}
                    style={{
                      background: statusColor(it.type || ""),
                      borderRadius: 4,
                      padding: "2px 4px",
                      marginBottom: 2,
                      cursor: "pointer"
                    }}
                    title={it.description}
                  >
                    {it.type || "scad."}
                  </div>
              ))}
            </div>
          );
        })}
      </div>
    </div>
  );
}

export default App;
